<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–æ—Ñ–ª–∞–π–Ω)</title>

  <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–¥–æ–ª–∂–Ω—ã –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º –≤ ./libs/) -->
  <script src="./libs/xlsx.full.min.js"></script>
  <script src="./libs/mammoth.browser.min.js"></script>
  <script src="./libs/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --primary: #4CAF50;
      --border: #C8E6C9;
      --text: #263238;
      --muted: #607D8B;
      --left-width: 26%; /* –Ω–∞—á–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      display: flex;
      height: 100vh;
      color: var(--text);
      background: #F5F5F5;
    }
    #left {
      flex: 0 0 var(--left-width);
      min-width: 240px;
      background: #F5F5F5;
      padding: 16px;
      overflow-y: auto;
      border-right: 1px solid var(--border);
    }
    #divider {
      width: 6px;
      cursor: col-resize;
      background: #E0E0E0;
      border-right: 1px solid var(--border);
      border-left: 1px solid #ddd;
    }
    #divider:hover { background: #CFD8DC; }
    body.resizing, body.resizing * { cursor: col-resize !important; user-select: none !important; }
    #right {
      flex: 1 1 auto;
      padding: 24px;
      overflow-y: auto;
      background: #F5F5F5;
    }
    h2 { margin: 0 0 12px 0; font-size: 18px; }
    .btn {
      display: block; width: 100%;
      padding: 10px 12px; margin-bottom: 12px;
      background: #78909C; color: #fff;
      border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
      transition: background .15s ease;
    }
    .btn.enabled { background: var(--primary); }
    .btn.enabled:hover { background: #2E7D32; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px; margin-bottom: 14px;
      border-radius: 6px; border: 1px solid var(--border); background: #fff;
    }
    details {
      background: #fff; border: 1px solid var(--border);
      border-radius: 8px; margin-bottom: 10px; padding: 10px;
    }
    summary {
      font-weight: 700; margin-bottom: 8px; cursor: pointer; color: #1B5E20;
    }
    .check-item { margin: 10px 0; }
    .check-item-title { font-weight: 700; margin-bottom: 6px; }
    textarea {
      width: 100%; border-radius: 6px; border: 1px solid var(--border);
      padding: 8px; resize: vertical; min-height: 56px; margin-top: 6px; background: #fff;
    }
    #docx-content {
      padding: 16px; background: #fff; border: 1px solid var(--border); border-radius: 8px; min-height: 80px;
    }
    #searchBar {
      position: sticky; top: 0; background: #F5F5F5; padding-bottom: 8px; z-index: 5;
      display: flex; gap: 10px; align-items: center; margin-bottom: 10px;
    }
    .search-match { background: yellow; padding: 0 2px; border-radius: 2px; }

    /* –û—Ç—á—ë—Ç ‚Äî –Ω–µ —Ä–≤—ë–º —Å—Ç—Ä–æ–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö */
    .no-break { page-break-inside: avoid; break-inside: avoid; }
    thead { display: table-header-group; }
    table.report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #fff; table-layout: fixed; }
    table.report-table th, table.report-table td {
      border: 1px solid #ccc; padding: 6px; word-wrap: break-word; vertical-align: top; text-align: left;
    }
    table.report-table th { background: #f0f0f0; }

    /* –¶–≤–µ—Ç —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞ */
    input[type="radio"].status-yes:checked { accent-color: #2E7D32; }
    input[type="radio"].status-no:checked  { accent-color: #C62828; }
    input[type="radio"].status-na:checked  { accent-color: #757575; }
  </style>
</head>
<body>
  <div id="left">
    <h2>–ß–µ–∫-–ª–∏—Å—Ç</h2>

    <button id="chooseScriptBtn" class="btn">–í—ã–±—Ä–∞—Ç—å Excel —Å —á–µ–∫-–ª–∏—Å—Ç–æ–º</button>
    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" />

    <label for="docType"><b>–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞</b></label>
    <select id="docType"><option value="">‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option></select>

    <div id="checklist"><p style="color:#607D8B">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Å —á–µ–∫-–ª–∏—Å—Ç–æ–º.</p></div>

    <!-- –ö–Ω–æ–ø–∫–∞ —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞; –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ -->
    <button id="downloadReport" class="btn">üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</button>
  </div>

  <div id="divider" aria-label="–ò–∑–º–µ–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É" title="–ü–æ—Ç—è–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —à–∏—Ä–∏–Ω—É"></div>

  <div id="right">
    <h2>–û–±–ª–∞—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>

    <input type="file" id="docxFile" accept=".docx" style="margin-bottom:10px;" />

    <div id="searchBar">
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É‚Ä¶" style="flex:1;">
      <button id="prevMatch" class="btn" style="display:none; width:auto;">‚Üê –ù–∞–∑–∞–¥</button>
      <button id="nextMatch" class="btn" style="display:none; width:auto;">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>

    <div id="docx-content"><p><em>–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.</em></p></div>
  </div>

  <script>
    const chooseScriptBtn = document.getElementById('chooseScriptBtn');
    const fileInput = document.getElementById('excelFile');
    const docTypeSelect = document.getElementById('docType');
    const checklistDiv = document.getElementById('checklist');
    const downloadBtn = document.getElementById('downloadReport');
    const docxInput = document.getElementById('docxFile');
    const docxContent = document.getElementById('docx-content');
    const searchInput = document.getElementById('searchInput');
    const prevBtn = document.getElementById('prevMatch');
    const nextBtn = document.getElementById('nextMatch');
    const divider = document.getElementById('divider');

    let allConditions = [];
    let answers = {};
    let originalDocxHTML = '';
    let uploadedDocNameBase = '';

    // –ò–º–µ–Ω–∞ —Ä–∞–∑–¥–µ–ª–æ–≤
    const GROUP_TITLES = {
      checklist: '–ß–µ–∫-–ª–∏—Å—Ç',
      critical_clauses: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è',
      risk_map: '–ö–∞—Ä—Ç–∞ —Ä–∏—Å–∫–æ–≤'
    };
    const displayGroupTitle = (code) => GROUP_TITLES[String(code||'').trim()] || code || '–†–∞–∑–¥–µ–ª';

    // === –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ (–∑–µ–ª—ë–Ω–∞—è, –µ—Å–ª–∏ –≤—Å—ë –∑–∞–ø–æ–ª–Ω–µ–Ω–æ), –Ω–æ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ ===
    function updateReportButton(){
      const type = docTypeSelect.value || '';
      const visible = allConditions.filter(it => !it.contract_type || it.contract_type === type);
      const allFilled = visible.length > 0 && visible.every(it => answers[it.id] && answers[it.id].status);
      // –ö–Ω–æ–ø–∫—É –Ω–µ –æ—Ç–∫–ª—é—á–∞–µ–º: –Ω—É–∂–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω–æ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏
      downloadBtn.disabled = false;
      downloadBtn.classList.toggle('enabled', allFilled);
    }

    // === –†–µ–Ω–¥–µ—Ä —á–µ–∫-–ª–∏—Å—Ç–∞ (–≤—Å–µ —Å–µ–∫—Ü–∏–∏ —Å–≤—ë—Ä–Ω—É—Ç—ã) ===
    function renderChecklist(type) {
      checklistDiv.innerHTML='';
      const filtered = allConditions.filter(it => !it.contract_type || it.contract_type === type);
      const groups = {};
      filtered.forEach(it => { if(!groups[it.group]) groups[it.group] = []; groups[it.group].push(it); });

      for (const g in groups) {
        const details = document.createElement('details'); details.open = false;
        const summary = document.createElement('summary'); summary.textContent = displayGroupTitle(g);
        details.appendChild(summary);

        groups[g].forEach(item => {
          if(!answers[item.id]) answers[item.id] = { status:'', comment:'' };

          const div = document.createElement('div');
          div.className = 'check-item';
          if (item.tooltip) div.title = item.tooltip;

          const t = document.createElement('div'); t.className = 'check-item-title'; t.textContent = item.text; if(item.tooltip) t.title=item.tooltip;
          div.appendChild(t);

          ['yes','no','na'].forEach(val=>{
            const r = document.createElement('input');
            r.type='radio'; r.name='a-'+item.id; r.value=val; r.className = 'status-' + val;
            if(answers[item.id].status===val) r.checked=true;
            r.onchange=()=>{ answers[item.id].status=val; updateReportButton(); };
            const l = document.createElement('label'); l.style.marginRight='12px'; l.appendChild(r);
            l.append(' '+({yes:'–°–æ–±–ª—é–¥–µ–Ω–æ',no:'–ù–µ —Å–æ–±–ª—é–¥–µ–Ω–æ',na:'–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ'}[val]));
            div.appendChild(l);
          });

          const ta = document.createElement('textarea');
          ta.placeholder = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)';
          ta.value = answers[item.id].comment || '';
          ta.oninput = e => answers[item.id].comment = e.target.value;
          div.appendChild(ta);

          details.appendChild(div);
        });

        checklistDiv.appendChild(details);
      }
      updateReportButton();
    }

    // === –ß—Ç–µ–Ω–∏–µ Excel ===
    chooseScriptBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
        // –ø–µ—Ä–≤—ã–π –Ω–µ–ø—É—Å—Ç–æ–π –ª–∏—Å—Ç
        let sheet = null;
        for (const name of wb.SheetNames) {
          const s = wb.Sheets[name];
          const j = XLSX.utils.sheet_to_json(s, { defval: '' });
          if (j && j.length) { sheet = s; break; }
        }
        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        allConditions = json.map((row,i)=> ({
          id: String(row.id || 'auto_'+(i+1)).trim(),
          group: String(row.group || 'checklist').trim(),
          contract_type: String(row.contract_type || '').trim(),
          text: String(row.text || '').trim(),
          tooltip: String(row.tooltip || '').trim()
        })).filter(r => r.text);
        const types = [...new Set(allConditions.map(it=>it.contract_type).filter(Boolean))];
        if (!types.length) types.push('–û–±—â–∏–π');
        docTypeSelect.innerHTML = types.map(t=>`<option>${t}</option>`).join('');
        docTypeSelect.value = types[0];
        renderChecklist(types[0]);
      };
      reader.readAsArrayBuffer(file);
    });
    docTypeSelect.addEventListener('change', e=>renderChecklist(e.target.value));

    // === –ó–∞–≥—Ä—É–∑–∫–∞ DOCX –∏ –ø–æ–∏—Å–∫ (–∫–Ω–æ–ø–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã –∏ –ø—Ä–∏ –æ–¥–Ω–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏) ===
    docxInput.addEventListener('change', (e)=>{
      const file=e.target.files[0]; if(!file) return;
      uploadedDocNameBase=file.name.replace(/\.[^.]+$/,''); const reader=new FileReader();
      reader.onload=evt=>{ mammoth.convertToHtml({arrayBuffer:evt.target.result}).then(res=>{ originalDocxHTML=res.value||'<p>(–ü—É—Å—Ç–æ)</p>'; docxContent.innerHTML=originalDocxHTML; }); };
      reader.readAsArrayBuffer(file);
    });
    let matches=[]; let current=-1;
    function focusMatch(){ matches.forEach((el,i)=>{ el.style.backgroundColor=i===current?'#FFD54F':'yellow'; el.style.fontWeight=i===current?'700':'400'; }); if(matches[current]) matches[current].scrollIntoView({behavior:'smooth',block:'center'}); }
    function doHighlight(term){
      if(!originalDocxHTML || !term){
        docxContent.innerHTML=originalDocxHTML || '<p><em>–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.</em></p>';
        prevBtn.style.display=nextBtn.style.display='none'; return;
      }
      const re=new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
      docxContent.innerHTML=originalDocxHTML.replace(re,m=>`<span class="search-match">${m}</span>`);
      matches=[...docxContent.querySelectorAll('.search-match')]; current = matches.length ? 0 : -1; focusMatch();
      prevBtn.style.display = nextBtn.style.display = matches.length >= 1 ? 'inline-block' : 'none';
    }
    searchInput.oninput=()=>doHighlight(searchInput.value.trim());
    prevBtn.onclick=()=>{ if(!matches.length) return; current=(current-1+matches.length)%matches.length; focusMatch();};
    nextBtn.onclick=()=>{ if(!matches.length) return; current=(current+1)%matches.length; focusMatch();};

    // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ (—Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ñ–∞–π–ª–∞) ===
    downloadBtn.onclick=()=>{
      const type=docTypeSelect.value||'';
      const visible=allConditions.filter(it=>!it.contract_type||it.contract_type===type);
      const missing=visible.filter(it=>!answers[it.id]||!answers[it.id].status);
      if(missing.length){
        alert('–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞:\n\n'+missing.map((m,i)=>`${i+1}. ${m.text}`).join('\n')+'\n\n–£–∫–∞–∂–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É.');
        const first=missing[0];
        if(first){ const target=document.querySelector(`[name="a-${CSS.escape(first.id)}"]`); if(target){ target.scrollIntoView({behavior:'smooth',block:'center'}); target.focus(); } }
        return;
      }
      const grouped={}; visible.forEach(it=>{ if(!grouped[it.group]) grouped[it.group]=[]; grouped[it.group].push(it); });
      const wrap=document.createElement('div'); 
      const title=uploadedDocNameBase ? uploadedDocNameBase : (type||'–î–æ–∫—É–º–µ–Ω—Ç');
      wrap.innerHTML=`<h2>–û—Ç—á—ë—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É (${title})</h2>`;
      const titleMap={checklist:'–ß–µ–∫-–ª–∏—Å—Ç',critical_clauses:'–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è',risk_map:'–ö–∞—Ä—Ç–∞ —Ä–∏—Å–∫–æ–≤'};
      for(const g in grouped){
        wrap.innerHTML+=`<h3>${titleMap[g]||g}</h3>`;
        let html='<table class="report-table no-break"><thead><tr><th>–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead><tbody>';
        grouped[g].forEach(it=>{
          const a=answers[it.id]; const statusMap={yes:'–°–æ–±–ª—é–¥–µ–Ω–æ',no:'–ù–µ —Å–æ–±–ª—é–¥–µ–Ω–æ',na:'–ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ'}; const color={yes:'green',no:'red',na:'gray'};
          html+=`<tr class="no-break"><td>${it.text}</td><td style="color:${color[a.status]};font-weight:bold;">${statusMap[a.status]}</td><td>${(a.comment||'').replace(/</g,'&lt;')}</td></tr>`;
        });
        html+='</tbody></table>'; wrap.innerHTML+=html;
      }
      html2pdf().set({margin:10,filename:`–û—Ç—á—ë—Ç –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É (${title}).pdf`,html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).from(wrap).save();
    };

    // === –†–µ–≥—É–ª–∏—Ä—É–µ–º–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã) ===
    (function(){
      const key='leftWidthPct';
      const saved=localStorage.getItem(key);
      if(saved) document.documentElement.style.setProperty('--left-width', saved);
      let dragging=false;
      divider.addEventListener('mousedown', ()=>{ dragging=true; document.body.classList.add('resizing'); });
      window.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        const total=document.body.clientWidth;
        const minLeft=220, maxLeft=total-360;
        let x=Math.min(Math.max(e.clientX, minLeft), maxLeft);
        const pct=(x/total*100).toFixed(2)+'%';
        document.documentElement.style.setProperty('--left-width', pct);
        localStorage.setItem(key, pct);
      });
      window.addEventListener('mouseup', ()=>{ dragging=false; document.body.classList.remove('resizing'); });
      divider.addEventListener('dblclick', ()=>{ const v='26%'; document.documentElement.style.setProperty('--left-width', v); localStorage.setItem(key, v); });
    })();
  </script>
</body>
</html>
